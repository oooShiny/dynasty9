<?php

use Drupal\taxonomy\Entity\Term;
use Drupal\node\Entity\Node;
use Drupal\dynasty_module\DynastyHelpers;

/**
 * Calculating Brady QB Rating field for game nodes.
 */
function dynasty_module_update_8001() {
  $games = \Drupal::entityTypeManager()->getStorage('node')->loadByProperties([
    'type' => 'game',
    'field_brady_played' => TRUE,
  ]);

  foreach ($games as $game) {
    $att = $game->get('field_brady_attempts')->value;
    $comp = $game->get('field_brady_completions')->value;
    $int = $game->get('field_brady_ints')->value;
    $td = $game->get('field_brady_tds')->value;
    $yds = $game->get('field_brady_yards')->value;

    $rating = DynastyHelpers::passer_rating($att, $comp, $yds, $td, $int);
    $game->set('field_passer_rating', $rating);
    $game->save();
  }
}

/**
 * Setting empty download fields to zero in Podcast Episodes.
 */
function dynasty_module_update_8002() {
  $nodes = \Drupal::entityTypeManager()->getStorage('node')->loadByProperties([
    'type' => 'podcast_episode',
  ]);

  foreach ($nodes as $node) {
    foreach ($node->get('field_monthly_downloads')->referencedEntities() as $p) {
      if ($p->get('field_downloads')->isEmpty()) {
        $p->set('field_downloads', 0);
        $p->save();
      }
    }
  }
}
function dynasty_module_theme($existing, $type, $theme, $path) {
  return [
    'footer_seasons_block' => [
      'variables' => [
        'seasons' => ''
      ]
    ],
    'prev_next_block' => [
      'variables' => [
        'previous' => '',
        'next' => '',
      ]
    ],
    'latest_podcast_block' => [
      'variables' => [
        'episode' => ''
      ]
    ],
    'record_vs_nfl_block' => [
      'variables' => [
        'records' => ''
      ]
    ],
    'total_podcast_downloads_block' => [
      'variables' => [
        'downloads' => '',
        'months' => ''
      ]
    ],
    'top_10_podcast_block' => [
      'variables' => [
        'downloads' => ''
      ]
    ],
    'on_this_day_block' => [
      'variables' => [
        'games' => ''
      ]
    ],
    'brady_td_viz' => [
      'variables' => []
    ],
    'team_games_table' => [
      'variables' => [
        'games' => '',
        'totals' => '',
        'opp' => '',
        'offset' => ''
      ]
    ],
    'brady_total_tds' => [
      'variables' => [
        'players' => '',
        'playercount' => '',
        'quarters' => '',
        'q_count' => '',
        'tdyards' => '',
        'tdposition' => '',
        'alltds' => ''
      ]
    ],
  ];
}
/**
 * Implements hook_entity_presave().
 */
function dynasty_module_entity_presave(Drupal\Core\Entity\EntityInterface $entity) {
  switch ($entity->bundle()) {
    case 'podcast_episode':
      if (!$entity->field_season->isEmpty() && !$entity->field_episode->isEmpty()) {
        // Get values from podcast node.
        $season = $entity->field_season->value;
        $week = $entity->field_episode->value;
        // Adjust playoff episode weeks to actual week numbers.
        if ($week > 17) {
          $title = $entity->label();
          if (strpos($title, 'Wildcard') !== FALSE) {
            $week = 18;
          }
          elseif (strpos($title, 'Divisional') !== FALSE) {
            $week = 19;
          }
          elseif (strpos($title, 'Championship') !== FALSE) {
            $week = 20;
          }
          elseif (strpos($title, 'Super') !== FALSE) {
            $week = 21;
          }
        }
        // Map podcast week to game week taxonomy term.
        $tids = \Drupal::entityQuery('taxonomy_term')
          ->condition('vid', 'week')
          ->execute();
        $terms = Term::loadMultiple($tids);
        $weeks = [];
        foreach ($terms as $term) {
          $name = $term->label();
          if (strpos($term->label(), 'Week') !== FALSE) {
            $week_array = explode(' ', $term->label());
            $w = end($week_array);
            $weeks[$w] = $term->id();
          }
          else {
            switch ($term->label()) {
              case 'Wildcard':
                $weeks[18] = $term->id();
                break;
              case 'AFC Divisional Round':
                $weeks[19] = $term->id();
                break;
              case 'AFC Conference Championship':
                $weeks[20] = $term->id();
                break;
              case 'Super Bowl':
                $weeks[21] = $term->id();
                break;
            }
          }
        }
        // Find game from season + week.
        $game = \Drupal::entityTypeManager()->getStorage('node')->loadByProperties([
          'type' => 'game',
          'field_season' => $season,
          'field_week' => $weeks[$week]
        ]);
        $game_ref = reset($game);
        if ($game_ref) {
          $entity->field_game->target_id = $game_ref->id();
        }
      }
      // Convert MP3 URL to the one Acast uses for their iFrames.
      if (!$entity->field_mp3->isEmpty()) {
        $mp3 = parse_url($entity->field_mp3->value);
        $path = explode('/', $mp3['path']);
        $entity->field_iframe->value = 'https://embed.acast.com/' . $path[4];
      }
      break;
    case 'highlight':
      // Automatically add game info to game fields.
      if (!$entity->field_game->isEmpty()) {
        $game = \Drupal::entityTypeManager()->getStorage('node')->load($entity->field_game->target_id);
        $entity->field_season->value = $game->field_season->value;
        $entity->field_week->target_id = $game->field_week->target_id;
        $entity->field_opponent->target_id = $game->field_opponent->target_id;
      }
      // Format muse video ID field if a link is posted.
      if (!$entity->field_video_file_id->isEmpty() && filter_var($entity->field_video_file_id->value, FILTER_VALIDATE_URL)) {
        $url_array = parse_url($entity->field_video_file_id->value);
        $path_array = explode('/', $url_array['path']);
        $entity->field_video_file_id->value = $path_array[2];
      }
      break;
  }
}
